<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PlayTanuki — Профиль</title>
<link rel="icon" type="image/png" href="browsericon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
  /* ═══ RESET ═══ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  /* ═══ FONTS ═══ */
  @font-face {
    font-family: 'MinecraftFive';
    src: url('minecraft-five-c.otf.woff2') format('woff2');
    font-weight: normal; font-style: normal;
  }
  @font-face {
    font-family: 'MinecraftFive';
    src: url('minecraft-five-bold-c.otf.woff2') format('woff2');
    font-weight: bold; font-style: normal;
  }
  @font-face {
    font-family: 'MinecraftSeven';
    src: url('Minecraft Seven_2.ttf') format('truetype');
    font-weight: normal; font-style: normal;
  }
  @font-face {
    font-family: 'MinecraftFiveOG';
    src: url('minecraft-five.otf.woff2') format('woff2');
    font-weight: normal; font-style: normal;
  }
  @font-face {
    font-family: 'MinecraftFiveOG';
    src: url('minecraft-five-bold.otf.woff2') format('woff2');
    font-weight: bold; font-style: normal;
  }
  @font-face {
    font-family: 'MinecraftTen';
    src: url('MinecraftTen-VGORe.ttf') format('truetype');
    font-weight: normal; font-style: normal;
  }

  /* ═══ TOKENS ═══ */
  :root {
    --color-primary:    #3c8527;
    --color-primary-lt: #4a9e30;
    --color-tertiary:   #a0e080;
    --color-shark:      #1d1e1e;
    --color-soil:       #313131;
    --color-tundora:    #404040;
    --color-scorpion:   #5a5a5a;
    --color-gravel:     #757575;
    --color-dusty:      #949494;
    --color-hint:       #d7ccc8;
    --color-white:      #fff;

    --font-body:    'Noto Sans', Arial, Helvetica, sans-serif;
    --font-mc-five: 'MinecraftFiveOG', 'MinecraftFive', 'Courier New', monospace;
    --font-mc-seven:'MinecraftSeven', 'Courier New', monospace;
    --font-mc-ten:  'MinecraftTen', 'MinecraftSeven', 'Courier New', monospace;

    --bdr: 4px;
  }

  html { scroll-behavior: smooth; }

  body {
    background-color: var(--color-soil);
    background-image: url('minecraft.wiki/longurls/Background-55659f57.png');
    background-repeat: repeat;
    background-size: 512px 512px;
    image-rendering: pixelated;
    color: var(--color-white);
    font-family: var(--font-body);
    font-size: 16px;
    line-height: 1.5;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    -webkit-font-smoothing: antialiased;
  }

  /* ═══ HEADER ═══ */
  .site-header {
    width: 100%;
    min-height: 280px;
    background-image: url('minecraft.wiki/longurls/Header-bac-59de7ae.png');
    background-repeat: repeat-x;
    background-size: auto 280px;
    background-position: center top;
    image-rendering: pixelated;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px 20px;
    position: relative;
  }
  .site-header a { display: flex; justify-content: center; }
  .header-logo {
    width: 500px;
    max-width: 85%;
    image-rendering: pixelated;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,.6));
  }

  /* ═══ MAIN ═══ */
  .main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 32px 24px 32px;
  }

  .page-title {
    font-family: var(--font-mc-ten);
    font-size: 22px;
    color: var(--color-tertiary);
    text-shadow: 3px 3px 0 rgba(0,0,0,.6);
    text-transform: uppercase;
    letter-spacing: 1px;
    text-align: center;
    margin-bottom: 20px;
  }

  /* ── Shared form styles ── */
  .panel {
    width: 100%;
    max-width: 440px;
    background: rgba(0,0,0,.35);
    border: 2px solid var(--color-tundora);
    padding: 28px 24px;
  }
  .form-group { margin-bottom: 12px; }
  .form-label {
    display: block;
    font-family: var(--font-mc-five);
    font-size: 11px;
    color: var(--color-dusty);
    text-shadow: 2px 2px 0 rgba(0,0,0,.6);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 8px;
  }
  .form-input {
    width: 100%;
    font-family: var(--font-body);
    font-size: 15px;
    color: var(--color-white);
    background: rgba(0,0,0,.4);
    border: 2px solid var(--color-scorpion);
    padding: 10px 12px;
    outline: none;
    transition: border-color .2s;
  }
  .form-input:focus { border-color: var(--color-primary); }
  .form-input::placeholder { color: var(--color-scorpion); font-size: 13px; }

  .form-message {
    font-family: var(--font-mc-seven);
    font-size: 13px;
    text-shadow: 2px 2px 0 rgba(0,0,0,.6);
    text-align: center;
    margin-top: 16px;
    min-height: 18px;
  }
  .form-message.success { color: var(--color-tertiary); }
  .form-message.error { color: #e04848; }

  /* ── MC Button ── */
  .mc-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-family: var(--font-body);
    font-size: 16px;
    font-weight: 600;
    line-height: 1;
    color: var(--color-white);
    border: none;
    outline: none;
    padding: 11px 24px;
    cursor: pointer;
    transition: filter .12s, background .12s;
    clip-path: polygon(
      0 var(--bdr), var(--bdr) var(--bdr), var(--bdr) 0,
      calc(100% - var(--bdr)) 0, calc(100% - var(--bdr)) var(--bdr), 100% var(--bdr),
      100% calc(100% - var(--bdr)), calc(100% - var(--bdr)) calc(100% - var(--bdr)),
      calc(100% - var(--bdr)) 100%, var(--bdr) 100%,
      var(--bdr) calc(100% - var(--bdr)), 0 calc(100% - var(--bdr))
    );
    box-shadow: inset 0 -3px 0 rgba(0,0,0,.25), inset 0 3px 0 rgba(255,255,255,.15);
  }
  .mc-btn:active {
    box-shadow: inset 0 0 0 100px rgba(255,255,255,.2), inset 0 3px 0 rgba(0,0,0,.15);
  }
  .mc-btn.green { background: var(--color-primary); }
  .mc-btn.green:hover { background: var(--color-primary-lt); }
  .mc-btn.red { background: #8b2020; }
  .mc-btn.red:hover { background: #a52a2a; }
  .mc-btn.gray { background: var(--color-tundora); }
  .mc-btn.gray:hover { background: var(--color-scorpion); }
  .mc-btn:disabled { background: var(--color-scorpion); cursor: not-allowed; }
  .mc-btn.full { width: 100%; }

  /* ── Bento grid ── */
  .bento-grid {
    display: grid;
    grid-template-columns: 240px 1fr;
    grid-template-rows: auto auto;
    gap: 10px;
    width: 100%;
    max-width: 760px;
  }
  .bento-wide { grid-column: 1 / -1; }
  .bento-left { grid-column: 1; }
  .bento-right { grid-column: 2; }
  .bento-right-stack {
    grid-column: 2;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .pw-row {
    display: flex;
    gap: 10px;
  }
  .pw-row .form-group {
    flex: 1;
    margin-bottom: 0;
  }

  /* ── Profile sections ── */
  .section-title {
    font-family: var(--font-mc-five);
    font-size: 11px;
    color: var(--color-tertiary);
    text-shadow: 2px 2px 0 rgba(0,0,0,.6);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 10px;
    padding-bottom: 6px;
    border-bottom: 2px solid var(--color-tundora);
  }
  .profile-section {
    width: 100%;
    background: rgba(0,0,0,.35);
    border: 2px solid var(--color-tundora);
    padding: 16px;
  }

  /* ── Status badge ── */
  .status-badge {
    font-family: var(--font-mc-five);
    font-size: 10px;
    letter-spacing: 1px;
    text-shadow: 2px 2px 0 rgba(0,0,0,.6);
    padding: 4px 10px;
    display: inline-block;
  }
  .status-badge.pending { color: #f0ad4e; }
  .status-badge.approved { color: var(--color-tertiary); }
  .status-badge.rejected { color: #e04848; }
  .status-badge.banned { color: #ff4444; font-weight: bold; }

  /* ── Player info ── */
  .player-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  .player-username {
    font-family: var(--font-mc-five);
    font-size: 16px;
    color: var(--color-tertiary);
    text-shadow: 2px 2px 0 rgba(0,0,0,.6);
  }
  .player-detail {
    font-family: var(--font-mc-seven);
    font-size: 12px;
    color: var(--color-dusty);
    text-shadow: 2px 2px 0 rgba(0,0,0,.6);
  }

  /* ── Skin preview ── */
  .skin-area {
    text-align: center;
  }
  .skin-viewer-wrap {
    width: 180px;
    height: 260px;
    margin: 0 auto 10px;
    border: 2px solid var(--color-tundora);
    background: rgba(0,0,0,.3);
    position: relative;
  }
  .skin-viewer-wrap canvas {
    width: 100% !important;
    height: 100% !important;
  }
  .skin-no-preview {
    font-family: var(--font-mc-seven);
    font-size: 12px;
    color: var(--color-scorpion);
    text-shadow: 2px 2px 0 rgba(0,0,0,.6);
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  .skin-toggle {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin-bottom: 8px;
  }
  .skin-toggle-btn {
    font-family: var(--font-mc-five);
    font-size: 10px;
    color: var(--color-dusty);
    background: rgba(0,0,0,.3);
    border: 2px solid var(--color-tundora);
    padding: 6px 14px;
    cursor: pointer;
    letter-spacing: 1px;
    transition: border-color .2s, color .2s;
  }
  .skin-toggle-btn:hover {
    border-color: var(--color-scorpion);
    color: var(--color-white);
  }
  .skin-toggle-btn.active {
    border-color: var(--color-primary);
    color: var(--color-tertiary);
  }
  .skin-file-input {
    display: none;
  }
  .skin-hint {
    font-family: var(--font-mc-seven);
    font-size: 11px;
    color: var(--color-scorpion);
    text-shadow: 2px 2px 0 rgba(0,0,0,.6);
    margin-top: 8px;
  }

  /* ── Back link ── */
  .back-link { margin-top: 24px; }
  .back-link a {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-family: var(--font-body);
    font-size: 15px;
    font-weight: 600;
    color: #86D562;
    text-decoration: none;
    padding: 12px 4px;
    border-bottom: 2px solid #86D562;
    transition: color .15s, border-color .15s;
  }
  .back-link a:hover { color: #9de87a; border-color: #9de87a; }
  .back-link .arrow {
    display: inline-flex;
    width: 16px; height: 16px;
    flex-shrink: 0;
    transition: transform .2s;
  }
  .back-link a:hover .arrow { transform: translateX(-3px); }

  /* ── Announcements ── */
  .announce-card {
    background: rgba(60,133,39,.08);
    border: 2px solid rgba(60,133,39,.25);
    padding: 12px 16px;
    margin-bottom: 8px;
  }
  .announce-text {
    font-family: var(--font-mc-seven);
    font-size: 13px;
    color: var(--color-hint);
    text-shadow: 2px 2px 0 rgba(0,0,0,.6);
    white-space: pre-wrap;
    word-break: break-word;
  }
  .announce-date {
    font-family: var(--font-mc-five);
    font-size: 9px;
    color: var(--color-scorpion);
    margin-top: 6px;
  }
  .announce-pager {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 10px;
  }
  .announce-pager button {
    font-family: var(--font-mc-five);
    font-size: 10px;
    color: var(--color-dusty);
    background: rgba(0,0,0,.3);
    border: 2px solid var(--color-tundora);
    padding: 5px 12px;
    cursor: pointer;
    letter-spacing: 1px;
    transition: border-color .2s, color .2s;
  }
  .announce-pager button:hover {
    border-color: var(--color-scorpion);
    color: var(--color-white);
  }
  .announce-pager button:disabled {
    color: var(--color-tundora);
    cursor: not-allowed;
    border-color: rgba(64,64,64,.5);
  }
  .announce-pager span {
    font-family: var(--font-mc-five);
    font-size: 10px;
    color: var(--color-scorpion);
  }

  /* ── Cape section ── */
  .cape-section-wrap {
    display: grid;
    grid-template-columns: 160px 1fr;
    gap: 14px;
  }
  .cape-preview-col {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .cape-viewer-wrap {
    width: 160px;
    height: 220px;
    border: 2px solid var(--color-tundora);
    background: rgba(0,0,0,.3);
    position: relative;
  }
  .cape-viewer-wrap canvas {
    width: 100% !important;
    height: 100% !important;
  }
  .cape-no-preview {
    font-family: var(--font-mc-seven);
    font-size: 12px;
    color: var(--color-scorpion);
    text-shadow: 2px 2px 0 rgba(0,0,0,.6);
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    white-space: nowrap;
  }
  .cape-controls {
    width: 100%;
    margin-top: 8px;
    display: flex;
    gap: 6px;
  }
  .cape-controls .mc-btn {
    font-size: 12px;
    padding: 7px 10px;
    flex: 1;
  }

  .cape-right-col {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .cape-warning {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    background: rgba(245,158,11,.08);
    border: 2px solid rgba(245,158,11,.3);
    padding: 8px 12px;
  }
  .cape-warning svg {
    flex-shrink: 0;
    width: 16px;
    height: 16px;
    color: #f59e0b;
    margin-top: 1px;
  }
  .cape-warning-text {
    font-family: var(--font-mc-seven);
    font-size: 11px;
    color: #f5d38a;
    text-shadow: 2px 2px 0 rgba(0,0,0,.6);
    line-height: 1.5;
  }
  .cape-warning-text a { color: #a0e080; }

  .cape-gallery-label {
    font-family: var(--font-mc-five);
    font-size: 10px;
    color: var(--color-dusty);
    text-shadow: 2px 2px 0 rgba(0,0,0,.6);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 5px;
  }

  /* Scrollable cape grid */
  .cape-gallery {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    max-height: 110px;
    overflow-y: auto;
    padding-right: 4px;
    scrollbar-width: thin;
    scrollbar-color: var(--color-tundora) transparent;
  }
  .cape-gallery::-webkit-scrollbar { width: 4px; }
  .cape-gallery::-webkit-scrollbar-track { background: transparent; }
  .cape-gallery::-webkit-scrollbar-thumb { background: var(--color-tundora); border-radius: 2px; }

  .cape-gallery-item {
    width: 42px;
    height: 42px;
    flex-shrink: 0;
    border: 2px solid var(--color-tundora);
    background: rgba(0,0,0,.3);
    cursor: pointer;
    transition: border-color .15s;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 3px;
  }
  .cape-gallery-item:hover {
    border-color: var(--color-scorpion);
  }
  .cape-gallery-item.selected {
    border-color: var(--color-primary);
    box-shadow: 0 0 6px rgba(60,133,39,.4);
  }
  .cape-gallery-item img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    image-rendering: pixelated;
  }

  /* Bedrock-style floating tooltip */
  .cape-tooltip {
    position: fixed;
    z-index: 9999;
    pointer-events: none;
    font-family: var(--font-mc-seven);
    font-size: 11px;
    color: var(--color-white);
    background: rgba(0, 0, 0, .7);
    border: none;
    padding: 5px 10px;
    white-space: nowrap;
    text-shadow: 2px 2px 0 rgba(0,0,0,.6);
    opacity: 0;
    transition: opacity .12s;
    clip-path: polygon(
      0 var(--bdr), var(--bdr) var(--bdr), var(--bdr) 0,
      calc(100% - var(--bdr)) 0, calc(100% - var(--bdr)) var(--bdr), 100% var(--bdr),
      100% calc(100% - var(--bdr)), calc(100% - var(--bdr)) calc(100% - var(--bdr)),
      calc(100% - var(--bdr)) 100%, var(--bdr) 100%,
      var(--bdr) calc(100% - var(--bdr)), 0 calc(100% - var(--bdr))
    );
  }
  .cape-tooltip.visible {
    opacity: 1;
  }

  .cape-or-divider {
    font-family: var(--font-mc-five);
    font-size: 10px;
    color: var(--color-scorpion);
    text-align: center;
    letter-spacing: 1px;
  }

  .cape-upload-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .cape-upload-row .mc-btn { font-size: 12px; padding: 7px 14px; white-space: nowrap; }
  .cape-upload-hint {
    font-family: var(--font-mc-seven);
    font-size: 11px;
    color: var(--color-scorpion);
    text-shadow: 2px 2px 0 rgba(0,0,0,.6);
  }

  @media (max-width: 700px) {
    .cape-section-wrap {
      grid-template-columns: 1fr;
    }
    .cape-preview-col {
      justify-self: center;
    }
    .cape-gallery {
      max-height: 90px;
    }
  }

  /* ── Danger zone ── */
  .danger-zone {
    border-color: #5a2020;
  }
  .danger-zone .section-title {
    color: #e04848;
    border-bottom-color: #5a2020;
  }
  .danger-text {
    font-family: var(--font-body);
    font-size: 14px;
    color: var(--color-dusty);
    text-shadow: 2px 2px 0 rgba(0,0,0,.6);
    margin-bottom: 6px;
  }
  .danger-list {
    font-family: var(--font-body);
    font-size: 13px;
    color: var(--color-scorpion);
    text-shadow: 2px 2px 0 rgba(0,0,0,.6);
    margin: 0 0 0 20px;
    padding: 0;
    list-style: disc;
    line-height: 1.7;
  }

  /* ═══ FOOTER ═══ */
  .site-footer {
    text-align: center;
    padding: 40px 24px 32px;
    border-top: 3px solid var(--color-tundora);
  }
  .footer-text {
    font-family: var(--font-mc-five);
    font-size: 10px;
    color: var(--color-scorpion);
    letter-spacing: 1px;
  }

  /* ═══ RESPONSIVE ═══ */
  @media (max-width: 700px) {
    .site-header { min-height: 200px; background-size: auto 200px; }
    .header-logo { width: 320px; }
    .main-content { padding: 32px 16px 32px; }
    .page-title { font-size: 18px; }
    .panel, .profile-section { padding: 14px; }
    .bento-grid { grid-template-columns: 1fr; }
    .bento-left, .bento-right { grid-column: 1; }
    .bento-left { grid-row: auto !important; }
    .pw-row { flex-direction: column; }
  }
</style>
</head>
<body>

<!-- ═══ HEADER ═══ -->
<header class="site-header">
  <a href="index.html"><img class="header-logo" src="minecraft_title.png" alt="PlayTanuki"></a>
</header>

<!-- ═══ MAIN ═══ -->
<main class="main-content">

  <!-- ── Login Section ── -->
  <div id="loginSection">
    <div class="page-title">Вход</div>
    <div class="panel">
      <div class="form-group">
        <label class="form-label" for="loginUser">Никнейм</label>
        <input class="form-input" type="text" id="loginUser" placeholder="Твой ник" autocomplete="off">
      </div>
      <div class="form-group" style="margin-bottom:0">
        <label class="form-label" for="loginPass">Пароль</label>
        <input class="form-input" type="password" id="loginPass" placeholder="Твой пароль">
      </div>
      <div class="form-message" id="loginMessage"></div>
      <button class="mc-btn green full" onclick="login()">Войти</button>
    </div>
    <div class="back-link">
      <a href="index.html">
        <svg class="arrow" viewBox="0 0 16 16" fill="none"><path d="M10 3l-5 5 5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>Назад на главную</span>
      </a>
    </div>
  </div>

  <!-- ── Profile Section ── -->
  <div id="profileSection" style="display:none; width:100%; flex-direction:column; align-items:center;">
    <div class="page-title">Профиль</div>

    <div class="bento-grid">

      <!-- Announcements — full width -->
      <div class="profile-section bento-wide" id="announceSection" style="display:none;">
        <div class="section-title">Объявления</div>
        <div id="announceList"></div>
      </div>

      <!-- Left: Skin (spans all rows) -->
      <div class="profile-section bento-left" style="grid-row: span 3;">
        <div class="section-title">Скин</div>
        <div class="skin-area">
          <div class="skin-viewer-wrap" id="skinViewer">
            <div class="skin-no-preview" id="skinNoPreview">Нет скина</div>
          </div>
          <div class="skin-toggle">
            <button class="skin-toggle-btn active" id="btnWide" onclick="setArmType('default')">Широкие</button>
            <button class="skin-toggle-btn" id="btnSlim" onclick="setArmType('slim')">Тонкие</button>
          </div>
          <input type="file" id="skinFile" class="skin-file-input" accept=".png" onchange="uploadSkin()">
          <button class="mc-btn green full" onclick="document.getElementById('skinFile').click()">Загрузить</button>
          <div class="skin-hint">PNG 64x64 / 64x32</div>
          <div class="form-message" id="skinMessage"></div>
        </div>
      </div>

      <!-- Right: Account info -->
      <div class="profile-section bento-right">
        <div class="section-title">Аккаунт</div>
        <div class="player-info-row">
          <span class="player-username" id="profUsername"></span>
          <span class="status-badge" id="profStatus"></span>
        </div>
        <div class="player-detail" id="profContact"></div>
      </div>

      <!-- Right: Contact + Password side by side -->
      <div class="profile-section bento-right">
        <div class="section-title">Контакт</div>
        <div class="form-group" style="margin-bottom:0">
          <input class="form-input" type="text" id="newContact" placeholder="@telegram или discord#1234">
        </div>
        <div class="form-message" id="contactMessage"></div>
        <button class="mc-btn green full" onclick="updateContact()" style="margin-top:8px;">Сохранить</button>
      </div>

      <!-- Right: Password -->
      <div class="profile-section bento-right">
        <div class="section-title">Сменить пароль</div>
        <div class="form-group" style="margin-bottom:8px">
          <input class="form-input" type="password" id="oldPassword" placeholder="Текущий пароль">
        </div>
        <div class="pw-row">
          <div class="form-group">
            <input class="form-input" type="password" id="newPassword" placeholder="Новый">
          </div>
          <div class="form-group">
            <input class="form-input" type="password" id="newPasswordConfirm" placeholder="Повтори">
          </div>
        </div>
        <div class="form-message" id="passwordMessage"></div>
        <button class="mc-btn green full" onclick="changePassword()" style="margin-top:8px;">Сменить</button>
      </div>

      <!-- Full width: Cape section -->
      <div class="profile-section bento-wide" id="capeSection">
        <div class="section-title">Плащ</div>
        <div class="cape-section-wrap">

          <!-- Left: compact 3D preview -->
          <div class="cape-preview-col">
            <div class="cape-viewer-wrap" id="capeViewer">
              <div class="cape-no-preview" id="capeNoPreview">Нет плаща</div>
            </div>
            <div class="cape-controls">
              <button class="mc-btn green" id="capeSaveBtn" onclick="saveCape()" style="display:none;">Сохранить</button>
              <button class="mc-btn red" id="capeRemoveBtn" onclick="removeCape()" style="display:none;">Снять</button>
            </div>
            <div class="form-message" id="capeMessage" style="margin-top:4px; font-size:11px;"></div>
          </div>

          <!-- Right: gallery + upload -->
          <div class="cape-right-col">

            <div class="cape-warning">
              <svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg>
              <div class="cape-warning-text">
                Плащи видны только с модом <b>TanukiHelper</b> для Fabric (Java Edition).<br>
                Скачай мод и положи в папку <code style="background:rgba(0,0,0,.3); padding:1px 4px;">.minecraft/mods</code>
                <br>
                <a href="https://github.com/PlayTanuki/TanukiHelper/releases/download/v1.0.0/tanukihelper.jar" target="_blank" rel="noopener" style="display:inline-flex; align-items:center; gap:4px; margin-top:4px;">
                  <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor"><path d="M2.75 14A1.75 1.75 0 011 12.25v-2.5a.75.75 0 011.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 00.25-.25v-2.5a.75.75 0 011.5 0v2.5A1.75 1.75 0 0113.25 14H2.75z"/><path d="M7.25 7.689V2a.75.75 0 011.5 0v5.689l1.97-1.969a.749.749 0 111.06 1.06l-3.25 3.25a.749.749 0 01-1.06 0L4.22 6.78a.749.749 0 111.06-1.06l1.97 1.969z"/></svg>
                  Скачать TanukiHelper
                </a>
              </div>
            </div>

            <div>
              <div class="cape-gallery-label">Выбери плащ</div>
              <div class="cape-gallery" id="capeGallery"></div>
            </div>

            <div class="cape-or-divider">— ИЛИ —</div>

            <div>
              <div class="cape-gallery-label">Свой плащ</div>
              <div class="cape-upload-row">
                <input type="file" id="capeFile" style="display:none;" accept=".png" onchange="previewCustomCape()">
                <button class="mc-btn gray" onclick="document.getElementById('capeFile').click()">Загрузить PNG</button>
                <span class="cape-upload-hint">64x32 — стандартный формат</span>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Full width: Danger zone -->
      <div class="profile-section danger-zone bento-wide">
        <div class="section-title">Опасная зона</div>
        <div class="danger-text">
          Удаление аккаунта — <b>необратимое</b> действие. Будут удалены:
        </div>
        <ul class="danger-list">
          <li>Все данные аккаунта (никнейм, контакт, пароль)</li>
          <li>Загруженный скин</li>
          <li>Загруженный плащ</li>
          <li>Доступ к серверу и все данные на нём</li>
        </ul>
        <div class="danger-text" style="margin-top:8px; margin-bottom:14px; color:var(--color-scorpion); font-size:13px;">
          Восстановить аккаунт после удаления невозможно. Тебе придётся регистрироваться заново и ждать повторного одобрения.
        </div>
        <div class="form-message" id="deleteMessage"></div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="mc-btn red" onclick="deleteAccount()">Удалить аккаунт</button>
          <button class="mc-btn gray" onclick="logout()">Выйти</button>
        </div>
      </div>

    </div>

    <div class="back-link">
      <a href="index.html">
        <svg class="arrow" viewBox="0 0 16 16" fill="none"><path d="M10 3l-5 5 5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>Назад на главную</span>
      </a>
    </div>
  </div>

</main>

<!-- ═══ FOOTER ═══ -->
<footer class="site-footer">
  <div class="footer-text">Создано Fekyat/Фекиат</div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/skinview3d@3/bundles/skinview3d.bundle.min.js"></script>
<script>
  var SUPABASE_URL = 'https://bdwrvonkykccirctxrcc.supabase.co';
  var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkd3J2b25reWtjY2lyY3R4cmNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NDUwOTIsImV4cCI6MjA4NjEyMTA5Mn0.2OuWJw0PzOAhItibqfynmIFHz7bLAUSyBOyPrigDE6A';
  var db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  var currentPlayer = null;

  async function hashPassword(password) {
    var encoder = new TextEncoder();
    var data = encoder.encode(password);
    var hashBuffer = await crypto.subtle.digest('SHA-256', data);
    var hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');
  }

  // ── Login ──
  async function login() {
    var msg = document.getElementById('loginMessage');
    var username = document.getElementById('loginUser').value.trim();
    var password = document.getElementById('loginPass').value;

    msg.className = 'form-message';
    msg.textContent = '';

    if (!username || !password) {
      msg.className = 'form-message error';
      msg.textContent = 'Заполни все поля!';
      return;
    }

    var hash = await hashPassword(password);

    var { data, error } = await db
      .from('players')
      .select('*')
      .eq('username', username)
      .eq('password_hash', hash)
      .single();

    if (error || !data) {
      msg.className = 'form-message error';
      msg.textContent = 'Неверный ник или пароль!';
      return;
    }

    currentPlayer = data;
    localStorage.setItem('player_id', data.id);
    localStorage.setItem('player_hash', hash);
    showProfile();
  }

  function showProfile() {
    document.getElementById('loginSection').style.display = 'none';
    var prof = document.getElementById('profileSection');
    prof.style.display = 'flex';

    document.getElementById('profUsername').textContent = currentPlayer.username;

    var statusEl = document.getElementById('profStatus');
    statusEl.className = 'status-badge ' + currentPlayer.status;
    if (currentPlayer.status === 'pending') statusEl.textContent = 'Ожидает';
    else if (currentPlayer.status === 'approved') statusEl.textContent = 'Одобрен';
    else if (currentPlayer.status === 'banned') statusEl.textContent = 'Забанен';
    else statusEl.textContent = 'Отклонён';

    document.getElementById('profContact').textContent = currentPlayer.contact || '—';
    document.getElementById('newContact').value = currentPlayer.contact || '';

    // Load saved arm type
    currentArmType = currentPlayer.slim_arms ? 'slim' : 'default';
    document.getElementById('btnWide').className = 'skin-toggle-btn' + (currentArmType === 'default' ? ' active' : '');
    document.getElementById('btnSlim').className = 'skin-toggle-btn' + (currentArmType === 'slim' ? ' active' : '');

    loadSkin();
    loadAnnouncements();
    buildCapeGallery();
    loadCurrentCape();
  }

  // ── Announcements (paginated) ──
  var allAnnouncements = [];
  var announcePage = 0;
  var ANNOUNCE_PER_PAGE = 3;

  async function loadAnnouncements() {
    var { data } = await db.from('announcements').select('*').order('created_at', { ascending: false });
    var section = document.getElementById('announceSection');

    if (!data || data.length === 0) {
      section.style.display = 'none';
      return;
    }

    allAnnouncements = data;
    announcePage = 0;
    section.style.display = '';
    renderAnnouncePage();
  }

  function renderAnnouncePage() {
    var list = document.getElementById('announceList');
    var start = announcePage * ANNOUNCE_PER_PAGE;
    var page = allAnnouncements.slice(start, start + ANNOUNCE_PER_PAGE);
    var totalPages = Math.ceil(allAnnouncements.length / ANNOUNCE_PER_PAGE);

    var html = '';
    page.forEach(function(a) {
      var date = new Date(a.created_at).toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
      html += '<div class="announce-card">';
      html += '  <div class="announce-text">' + escapeHtml(a.message) + '</div>';
      html += '  <div class="announce-date">' + date + '</div>';
      html += '</div>';
    });

    if (totalPages > 1) {
      html += '<div class="announce-pager">';
      html += '  <button onclick="announceNav(-1)"' + (announcePage === 0 ? ' disabled' : '') + '>&lt;</button>';
      html += '  <span>' + (announcePage + 1) + ' / ' + totalPages + '</span>';
      html += '  <button onclick="announceNav(1)"' + (announcePage >= totalPages - 1 ? ' disabled' : '') + '>&gt;</button>';
      html += '</div>';
    }

    list.innerHTML = html;
  }

  function announceNav(dir) {
    var totalPages = Math.ceil(allAnnouncements.length / ANNOUNCE_PER_PAGE);
    announcePage = Math.max(0, Math.min(totalPages - 1, announcePage + dir));
    renderAnnouncePage();
  }

  function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ── Skin 3D Viewer ──
  var skinViewerInstance = null;
  var currentArmType = 'default';

  function loadSkin() {
    var container = document.getElementById('skinViewer');
    var noPreview = document.getElementById('skinNoPreview');
    var url = SUPABASE_URL + '/storage/v1/object/public/skins/' + currentPlayer.username + '.png?t=' + Date.now();

    // Test if skin exists
    var img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = function() {
      noPreview.style.display = 'none';
      initViewer(url);
    };
    img.onerror = function() {
      noPreview.style.display = '';
      if (skinViewerInstance) {
        skinViewerInstance.dispose();
        skinViewerInstance = null;
      }
    };
    img.src = url;
  }

  function initViewer(url) {
    var container = document.getElementById('skinViewer');

    if (skinViewerInstance) {
      skinViewerInstance.dispose();
      skinViewerInstance = null;
    }

    // Clear old canvases
    var oldCanvas = container.querySelector('canvas');
    if (oldCanvas) oldCanvas.remove();

    skinViewerInstance = new skinview3d.SkinViewer({
      canvas: document.createElement('canvas'),
      width: 180,
      height: 260,
      skin: url,
      model: currentArmType === 'slim' ? 'slim' : 'default'
    });

    skinViewerInstance.autoRotate = true;
    skinViewerInstance.autoRotateSpeed = 0.5;
    skinViewerInstance.zoom = 0.9;
    skinViewerInstance.fov = 50;
    skinViewerInstance.animation = new skinview3d.IdleAnimation();

    container.appendChild(skinViewerInstance.canvas);
  }

  async function setArmType(type) {
    currentArmType = type;
    document.getElementById('btnWide').className = 'skin-toggle-btn' + (type === 'default' ? ' active' : '');
    document.getElementById('btnSlim').className = 'skin-toggle-btn' + (type === 'slim' ? ' active' : '');

    // Save to database
    await db.from('players').update({ slim_arms: type === 'slim' }).eq('id', currentPlayer.id);
    currentPlayer.slim_arms = type === 'slim';

    if (skinViewerInstance) {
      skinViewerInstance.loadSkin(SUPABASE_URL + '/storage/v1/object/public/skins/' + currentPlayer.username + '.png?t=' + Date.now(), { model: type === 'slim' ? 'slim' : 'default' });
    }
  }

  async function uploadSkin() {
    var msg = document.getElementById('skinMessage');
    var fileInput = document.getElementById('skinFile');
    var file = fileInput.files[0];

    msg.className = 'form-message';
    msg.textContent = '';

    if (!file) return;

    if (file.type !== 'image/png') {
      msg.className = 'form-message error';
      msg.textContent = 'Только PNG!';
      return;
    }

    if (file.size > 50000) {
      msg.className = 'form-message error';
      msg.textContent = 'Файл слишком большой!';
      return;
    }

    var filename = currentPlayer.username + '.png';

    var { error } = await db.storage
      .from('skins')
      .upload(filename, file, { upsert: true });

    if (error) {
      msg.className = 'form-message error';
      msg.textContent = 'Ошибка: ' + error.message;
    } else {
      msg.className = 'form-message success';
      msg.textContent = 'Скин загружен!';
      loadSkin();
    }

    fileInput.value = '';
  }

  // ── Update Contact ──
  async function updateContact() {
    var msg = document.getElementById('contactMessage');
    var contact = document.getElementById('newContact').value.trim();

    msg.className = 'form-message';
    msg.textContent = '';

    if (!contact) {
      msg.className = 'form-message error';
      msg.textContent = 'Введи контакт!';
      return;
    }

    var { error } = await db
      .from('players')
      .update({ contact: contact })
      .eq('id', currentPlayer.id);

    if (error) {
      msg.className = 'form-message error';
      msg.textContent = 'Ошибка: ' + error.message;
    } else {
      currentPlayer.contact = contact;
      document.getElementById('profContact').textContent = contact;
      msg.className = 'form-message success';
      msg.textContent = 'Сохранено!';
    }
  }

  // ── Change Password ──
  async function changePassword() {
    var msg = document.getElementById('passwordMessage');
    var oldPass = document.getElementById('oldPassword').value;
    var newPass = document.getElementById('newPassword').value;
    var newPassConfirm = document.getElementById('newPasswordConfirm').value;

    msg.className = 'form-message';
    msg.textContent = '';

    if (!oldPass || !newPass || !newPassConfirm) {
      msg.className = 'form-message error';
      msg.textContent = 'Заполни все поля!';
      return;
    }

    var oldHash = await hashPassword(oldPass);
    if (oldHash !== currentPlayer.password_hash) {
      msg.className = 'form-message error';
      msg.textContent = 'Неверный текущий пароль!';
      return;
    }

    if (newPass.length < 6) {
      msg.className = 'form-message error';
      msg.textContent = 'Минимум 6 символов!';
      return;
    }

    if (newPass !== newPassConfirm) {
      msg.className = 'form-message error';
      msg.textContent = 'Пароли не совпадают!';
      return;
    }

    var newHash = await hashPassword(newPass);

    var { error } = await db
      .from('players')
      .update({ password_hash: newHash })
      .eq('id', currentPlayer.id);

    if (error) {
      msg.className = 'form-message error';
      msg.textContent = 'Ошибка: ' + error.message;
    } else {
      currentPlayer.password_hash = newHash;
      localStorage.setItem('player_hash', newHash);
      document.getElementById('oldPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('newPasswordConfirm').value = '';
      msg.className = 'form-message success';
      msg.textContent = 'Пароль изменён!';
    }
  }

  // ── Delete Account ──
  async function deleteAccount() {
    var msg = document.getElementById('deleteMessage');

    if (!confirm('Ты уверен? Это нельзя отменить!')) return;

    var { error } = await db
      .from('players')
      .delete()
      .eq('id', currentPlayer.id);

    if (error) {
      msg.className = 'form-message error';
      msg.textContent = 'Ошибка: ' + error.message;
    } else {
      // Also try to delete skin and cape
      await db.storage.from('skins').remove([currentPlayer.username + '.png']);
      await db.storage.from('capes').remove([currentPlayer.username + '.png']);
      logout();
    }
  }

  // ── Logout ──
  function logout() {
    currentPlayer = null;
    localStorage.removeItem('player_id');
    localStorage.removeItem('player_hash');
    document.getElementById('profileSection').style.display = 'none';
    document.getElementById('loginSection').style.display = '';
    document.getElementById('loginUser').value = '';
    document.getElementById('loginPass').value = '';
    document.getElementById('loginMessage').textContent = '';
  }

  // ── Auto-login from session ──
  (async function() {
    var id = localStorage.getItem('player_id');
    var hash = localStorage.getItem('player_hash');
    if (id && hash) {
      var { data } = await db
        .from('players')
        .select('*')
        .eq('id', id)
        .eq('password_hash', hash)
        .single();
      if (data) {
        currentPlayer = data;
        showProfile();
      }
    }
  })();

  // ── Cape System ──
  var capeViewerInstance = null;
  var selectedCapeBlob = null; // File or Blob to upload
  var selectedCapeUrl = null;  // URL for preview
  var currentCapeLoaded = false; // has saved cape

  // Official capes from Supabase Storage /capes/ bucket
  var CAPE_BASE = SUPABASE_URL + '/storage/v1/object/public/capes/';
  var OFFICIAL_CAPES = [
    { name: 'Ванилла', file: 'VanillaCape.png' },
    { name: 'Вишнёвый цвет', file: 'CherryBlossom.png' },
    { name: 'Мигратор', file: 'Migrator.png' },
    { name: 'Глазоцвет', file: 'Eyeblossom.png' },
    { name: 'Нюхач', file: 'Sniffer.png' },
    { name: 'Улитка', file: 'Snail.png' },
    { name: 'Лягушка', file: 'Frog.png' },
    { name: 'Медный', file: 'CopperCape.png' },
    { name: 'Тоска', file: 'YearnCape.png' },
    { name: 'Угроза', file: 'MenaceCape.png' },
    { name: 'Домашний', file: 'HomeCape.png' },
    { name: 'Пан', file: 'Pancape.png' },
    { name: 'Прогресс Прайд', file: 'ProgressPrideCape.png' },
    { name: 'Зомби-лошадь', file: 'ZombieHorse.png' },
    { name: '15 лет', file: '15YearCape.png' },
    { name: 'Основатель', file: 'FoundersCape.png' },
    { name: 'MC Чемпионат', file: 'MCChampionship.png' },
    { name: 'MC Опыт', file: 'MinecraftExperienceVillagerRescue.png' },
    { name: 'Mojang Studios', file: 'MojangStudios.png' },
    { name: 'Новый Mojang', file: 'NewMojang.png' },
    { name: 'Старый Mojang', file: 'OldMojang.png' },
    { name: 'Minecon 2011', file: '2011.png' },
    { name: 'Minecon 2012', file: '2012.png' },
    { name: 'Minecon 2013', file: '2013.png' },
    { name: 'Minecon 2015', file: '2015.png' },
    { name: 'Minecon 2016', file: '2016.png' },
    { name: 'Realms', file: 'Realms.png' },
    { name: 'Scrolls', file: 'Scrolls.png' },
    { name: 'Кобальт', file: 'Cobalt.png' },
    { name: '1 Миллион', file: '1Mill.png' },
    { name: 'Переводчик КН', file: 'Translator_Chinese.png' },
    { name: 'Переводчик', file: 'Translator_Crowdin.png' },
    { name: 'Переводчик ЯП', file: 'Translator_Japan.png' },
    { name: 'Баг-трекер', file: 'BugTracker.png' },
    { name: 'Черепаха', file: 'Turtle.png' },
    { name: 'Призмарин', file: 'Prismarine.png' },
    { name: 'Oxeye', file: 'Oxeye.png' },
    { name: 'Чертёж', file: 'Blueprint.png' },
    { name: 'Бекон', file: 'Bacon.png' },
    { name: 'Валентинка', file: 'Valentine.png' },
    { name: 'Новый год', file: 'NewYears.png' },
    { name: 'Рождество', file: 'Xmas.png' },
    { name: 'Xbox День рождения', file: 'XboxBirthday.png' },
    { name: 'TikTok', file: 'TikTokCape.png' },
    { name: 'Twitch', file: 'TwitchCape.png' },
    { name: 'dannyBstyle', file: 'dannyBstyle.png' },
    { name: 'JulianClark', file: 'JulianClark.png' },
    { name: 'MrMessiah', file: 'MrMessiah.png' },
    { name: 'Gr8 Escape', file: 'Gr8_Escape.png' },
  ];

  // Floating Bedrock-style tooltip
  var capeTooltip = document.createElement('div');
  capeTooltip.className = 'cape-tooltip';
  document.body.appendChild(capeTooltip);

  function showCapeTooltip(e, name) {
    capeTooltip.textContent = name;
    capeTooltip.classList.add('visible');
    moveCapeTooltip(e);
  }
  function moveCapeTooltip(e) {
    var x = e.clientX;
    var y = e.clientY;
    var tw = capeTooltip.offsetWidth;
    // Position above cursor, centered
    var left = x - tw / 2;
    var top = y - 34;
    // Keep on screen
    if (left < 4) left = 4;
    if (left + tw > window.innerWidth - 4) left = window.innerWidth - tw - 4;
    if (top < 4) top = y + 20;
    capeTooltip.style.left = left + 'px';
    capeTooltip.style.top = top + 'px';
  }
  function hideCapeTooltip() {
    capeTooltip.classList.remove('visible');
  }

  function buildCapeGallery() {
    var gallery = document.getElementById('capeGallery');
    var html = '';
    OFFICIAL_CAPES.forEach(function(cape, i) {
      var url = CAPE_BASE + cape.file;
      html += '<div class="cape-gallery-item" onclick="selectOfficialCape(' + i + ')" id="capeItem' + i + '" data-name="' + escapeHtml(cape.name) + '">';
      html += '  <img src="' + url + '" alt="' + escapeHtml(cape.name) + '" crossorigin="anonymous" draggable="false">';
      html += '</div>';
    });
    gallery.innerHTML = html;

    // Attach tooltip events
    var items = gallery.querySelectorAll('.cape-gallery-item');
    items.forEach(function(el) {
      el.addEventListener('mouseenter', function(e) {
        showCapeTooltip(e, el.getAttribute('data-name'));
      });
      el.addEventListener('mousemove', moveCapeTooltip);
      el.addEventListener('mouseleave', hideCapeTooltip);
    });
  }

  function selectOfficialCape(index) {
    // Deselect all
    var items = document.querySelectorAll('.cape-gallery-item');
    items.forEach(function(el) { el.classList.remove('selected'); });

    // Select this one
    document.getElementById('capeItem' + index).classList.add('selected');

    var cape = OFFICIAL_CAPES[index];
    var url = CAPE_BASE + cape.file;
    selectedCapeUrl = url;
    selectedCapeBlob = null; // will fetch on save

    previewCape(url);
    document.getElementById('capeSaveBtn').style.display = '';
  }

  function previewCustomCape() {
    var fileInput = document.getElementById('capeFile');
    var file = fileInput.files[0];
    if (!file) return;

    var msg = document.getElementById('capeMessage');
    msg.className = 'form-message';
    msg.textContent = '';

    if (file.type !== 'image/png') {
      msg.className = 'form-message error';
      msg.textContent = 'Только PNG!';
      fileInput.value = '';
      return;
    }

    if (file.size > 256000) {
      msg.className = 'form-message error';
      msg.textContent = 'Макс. 256 КБ!';
      fileInput.value = '';
      return;
    }

    // Deselect gallery
    var items = document.querySelectorAll('.cape-gallery-item');
    items.forEach(function(el) { el.classList.remove('selected'); });

    selectedCapeBlob = file;
    selectedCapeUrl = URL.createObjectURL(file);

    previewCape(selectedCapeUrl);
    document.getElementById('capeSaveBtn').style.display = '';
  }

  function previewCape(url) {
    var container = document.getElementById('capeViewer');
    var noPreview = document.getElementById('capeNoPreview');
    noPreview.style.display = 'none';

    if (!capeViewerInstance) {
      initCapeViewer();
    }

    capeViewerInstance.loadCape(url, { backEquipment: 'cape' });
  }

  function initCapeViewer() {
    var container = document.getElementById('capeViewer');
    var oldCanvas = container.querySelector('canvas');
    if (oldCanvas) oldCanvas.remove();

    var skinUrl = null;
    if (currentPlayer) {
      skinUrl = SUPABASE_URL + '/storage/v1/object/public/skins/' + currentPlayer.username + '.png?t=' + Date.now();
    }

    capeViewerInstance = new skinview3d.SkinViewer({
      canvas: document.createElement('canvas'),
      width: 160,
      height: 220,
      skin: skinUrl || undefined,
      model: currentArmType === 'slim' ? 'slim' : 'default'
    });

    capeViewerInstance.autoRotate = true;
    capeViewerInstance.autoRotateSpeed = 0.5;
    capeViewerInstance.zoom = 0.9;
    capeViewerInstance.fov = 50;
    capeViewerInstance.animation = new skinview3d.IdleAnimation();

    // Show from behind to see the cape
    capeViewerInstance.camera.rotation.y = Math.PI;

    container.appendChild(capeViewerInstance.canvas);
  }

  function loadCurrentCape() {
    var url = SUPABASE_URL + '/storage/v1/object/public/capes/' + currentPlayer.username + '.png?t=' + Date.now();
    var img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = function() {
      currentCapeLoaded = true;
      previewCape(url);
      document.getElementById('capeRemoveBtn').style.display = '';
      document.getElementById('capeNoPreview').style.display = 'none';
    };
    img.onerror = function() {
      currentCapeLoaded = false;
      document.getElementById('capeNoPreview').style.display = '';
      document.getElementById('capeRemoveBtn').style.display = 'none';
      // Hide the 3D viewer when no cape
      if (capeViewerInstance) {
        capeViewerInstance.dispose();
        capeViewerInstance = null;
        var c = document.getElementById('capeViewer').querySelector('canvas');
        if (c) c.remove();
      }
    };
    img.src = url;
  }

  async function saveCape() {
    var msg = document.getElementById('capeMessage');
    msg.className = 'form-message';
    msg.textContent = '';

    var blob = selectedCapeBlob;

    // If selected from gallery, fetch the image as blob
    if (!blob && selectedCapeUrl) {
      try {
        var resp = await fetch(selectedCapeUrl);
        blob = await resp.blob();
      } catch(e) {
        // CORS might block wiki images — draw to canvas instead
        blob = await fetchCapeViaCanvas(selectedCapeUrl);
      }
    }

    if (!blob) {
      msg.className = 'form-message error';
      msg.textContent = 'Выбери плащ!';
      return;
    }

    var filename = currentPlayer.username + '.png';

    var { error } = await db.storage
      .from('capes')
      .upload(filename, blob, { upsert: true, contentType: 'image/png' });

    if (error) {
      msg.className = 'form-message error';
      msg.textContent = 'Ошибка: ' + error.message;
    } else {
      msg.className = 'form-message success';
      msg.textContent = 'Плащ сохранён!';
      currentCapeLoaded = true;
      document.getElementById('capeRemoveBtn').style.display = '';
      document.getElementById('capeSaveBtn').style.display = 'none';
      selectedCapeBlob = null;
      selectedCapeUrl = null;
      // Deselect gallery
      var items = document.querySelectorAll('.cape-gallery-item');
      items.forEach(function(el) { el.classList.remove('selected'); });
    }
  }

  // Fallback: draw image to canvas to get blob (avoids CORS)
  function fetchCapeViaCanvas(url) {
    return new Promise(function(resolve) {
      var img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = function() {
        var canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        var ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        canvas.toBlob(function(b) {
          resolve(b);
        }, 'image/png');
      };
      img.onerror = function() { resolve(null); };
      img.src = url;
    });
  }

  async function removeCape() {
    var msg = document.getElementById('capeMessage');
    msg.className = 'form-message';
    msg.textContent = '';

    if (!confirm('Снять плащ?')) return;

    var filename = currentPlayer.username + '.png';
    var { error } = await db.storage.from('capes').remove([filename]);

    if (error) {
      msg.className = 'form-message error';
      msg.textContent = 'Ошибка: ' + error.message;
    } else {
      msg.className = 'form-message success';
      msg.textContent = 'Плащ снят.';
      currentCapeLoaded = false;
      document.getElementById('capeRemoveBtn').style.display = 'none';
      document.getElementById('capeNoPreview').style.display = '';
      if (capeViewerInstance) {
        capeViewerInstance.dispose();
        capeViewerInstance = null;
        var c = document.getElementById('capeViewer').querySelector('canvas');
        if (c) c.remove();
      }
    }
  }

  // Enter to login
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && document.getElementById('loginSection').style.display !== 'none') {
      login();
    }
  });
</script>

</body>
</html>
